<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceControl - Firebase Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* (O CSS √â ID√äNTICO AO ANTERIOR - MANTENDO O VISUAL QUE VOC√ä APROVOU) */
        :root { --bg-color: #12141e; --card-color: #1e2230; --text-color: #e0e6ed; --text-muted: #94a3b8; --green-neon: #10b981; --red-neon: #ef4444; --blue-accent: #3b82f6; --orange-accent: #f97316; --blue-mp: #009ee3; --border-color: #2d3748; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header-controls { display: flex; gap: 15px; align-items: center; }
        select { background: var(--card-color); color: white; border: 1px solid var(--border-color); padding: 10px; border-radius: 8px; font-size: 1rem; cursor: pointer; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: transform 0.2s; display: flex; align-items: center; gap: 5px; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-green { background: var(--green-neon); color: #000; }
        .btn-red { background: var(--red-neon); color: #fff; }
        .btn-ghost { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); }
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .card { background: var(--card-color); border-radius: 16px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5); border: 1px solid rgba(255,255,255,0.05); }
        .kpi-title { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 5px; }
        .kpi-value { font-size: 2rem; font-weight: 700; }
        .text-green { color: var(--green-neon); }
        .text-red { color: var(--red-neon); }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-container { position: relative; height: 250px; width: 100%; }
        .transactions-section { background: var(--card-color); border-radius: 16px; padding: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; color: var(--text-muted); padding: 10px; border-bottom: 1px solid var(--border-color); }
        td { padding: 15px 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; margin-right: 5px; }
        .tag-receita { background: rgba(16, 185, 129, 0.2); color: var(--green-neon); }
        .tag-despesa { background: rgba(239, 68, 68, 0.2); color: var(--red-neon); }
        .tag-credito { background: rgba(59, 130, 246, 0.2); color: var(--blue-accent); border: 1px solid var(--blue-accent); }
        .btn-delete { background: none; border: none; color: var(--text-muted); cursor: pointer; }
        .btn-delete:hover { color: var(--red-neon); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: var(--card-color); padding: 30px; border-radius: 16px; width: 450px; border: 1px solid var(--border-color); }
        .modal h2 { margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem;}
        .form-group input, .form-group select { width: 100%; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); color: white; border-radius: 8px; outline: none; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .hidden { display: none; }
        
        /* Loading Spinner para opera√ß√µes de rede */
        #loading { display: none; position: fixed; top: 20px; right: 20px; background: var(--blue-accent); color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; box-shadow: 0 0 10px rgba(59,130,246,0.5); z-index: 2000; }
    </style>
</head>
<body>

<div id="loading">‚òÅÔ∏è Sincronizando...</div>

<div class="container">
    <header>
        <div>
            <h1>Dashboard Financeiro <span style="font-size: 0.8rem; color: #f59e0b;">(Firebase Online)</span></h1>
            <p style="color: var(--text-muted)">Dados seguros na nuvem</p>
        </div>
        <div class="header-controls">
            <select id="filtroAno" style="width: 100px;">
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
                <option value="2026">2026</option>
            </select>

            <select id="filtroMes">
                <option value="todos">Todos os Meses</option>
                <option value="0">Janeiro</option>
                <option value="1">Fevereiro</option>
                <option value="2">Mar√ßo</option>
                <option value="3">Abril</option>
                <option value="4">Maio</option>
                <option value="5">Junho</option>
                <option value="6">Julho</option>
                <option value="7">Agosto</option>
                <option value="8">Setembro</option>
                <option value="9">Outubro</option>
                <option value="10">Novembro</option>
                <option value="11" selected>Dezembro</option>
            </select>
            
            <button class="btn btn-green" onclick="abrirModal('receita')">+ Receita</button>
            <button class="btn btn-red" onclick="abrirModal('despesa')">- Despesa</button>
            <button class="btn btn-ghost" onclick="limparDados()">üóëÔ∏è Reset DB</button>
        </div>
    </header>

    <div class="kpi-grid">
        <div class="card">
            <div class="kpi-title">Entradas</div>
            <div class="kpi-value text-green" id="totalReceitas">R$ ...</div>
        </div>
        <div class="card">
            <div class="kpi-title">Sa√≠das</div>
            <div class="kpi-value text-red" id="totalDespesas">R$ ...</div>
        </div>
        <div class="card">
            <div class="kpi-title">Saldo</div>
            <div class="kpi-value" id="totalSaldo">R$ ...</div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="card">
            <h3 style="margin-bottom: 15px;">Por Categoria</h3>
            <div class="chart-container"><canvas id="graficoRosca"></canvas></div>
        </div>
        <div class="card">
            <h3 style="margin-bottom: 15px;">Fatura Cart√µes</h3>
            <div class="chart-container"><canvas id="graficoCartoes"></canvas></div>
            <div style="text-align: center; margin-top: 10px; color: var(--text-muted); font-size: 0.8rem;">
                Fatura Estimada: <span id="totalCreditoTexto" style="color: #fff; font-weight: bold;">R$ 0,00</span>
            </div>
        </div>
        <div class="card">
            <h3 style="margin-bottom: 15px;">Fluxo</h3>
            <div class="chart-container"><canvas id="graficoBarras"></canvas></div>
        </div>
    </div>

    <div class="transactions-section">
        <h3 style="margin-bottom: 10px;">Lan√ßamentos</h3>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Descri√ß√£o</th>
                    <th>Categoria</th>
                    <th>M√©todo</th>
                    <th>Valor</th>
                    <th>A√ß√£o</th>
                </tr>
            </thead>
            <tbody id="tabelaTransacoes">
                <tr><td colspan="6" style="text-align:center">Carregando dados da nuvem...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal-overlay" id="modalTransacao">
    <div class="modal">
        <h2 id="modalTitulo">Nova Transa√ß√£o</h2>
        <input type="hidden" id="tipoTransacao">
        
        <div class="form-group">
            <label>Descri√ß√£o</label>
            <input type="text" id="descInput" placeholder="Ex: Monitor Novo...">
        </div>
        <div class="form-group">
            <label>Valor Total (R$)</label>
            <input type="number" id="valorInput" step="0.01" placeholder="0.00">
        </div>
        <div class="form-group">
            <label>Categoria</label>
            <select id="catSelect" onchange="verificarCategoriaCustom(this.value)"></select>
            <input type="text" id="catCustom" class="hidden" placeholder="Nome da categoria..." style="margin-top: 10px; border-color: var(--blue-accent);">
        </div>
        <div class="form-group">
            <label>Forma de Pagamento</label>
            <select id="metodoInput" onchange="verificarMetodoPagamento(this.value)">
                <option value="debito">D√©bito / Dinheiro / Pix</option>
                <option value="credito">Cart√£o de Cr√©dito</option>
            </select>
        </div>
        <div id="divDetalhesCredito" class="hidden" style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--blue-accent);">
            <div class="form-group">
                <label style="color: var(--blue-accent);">Qual Cart√£o?</label>
                <select id="cartaoSelect">
                    <option value="Itau">Ita√∫</option>
                    <option value="Mercado Pago">Mercado Pago</option>
                    </select>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label style="color: var(--blue-accent);">Parcelas</label>
                <select id="parcelasSelect">
                    <option value="1">1x (√Ä vista)</option>
                    <option value="2">2x</option>
                    <option value="3">3x</option>
                    <option value="6">6x</option>
                    <option value="10">10x</option>
                    <option value="12">12x</option>
                    <option value="18">18x</option>
                    <option value="24">24x</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>Data</label>
            <input type="date" id="dataInput">
        </div>
        <div class="modal-buttons">
            <button class="btn btn-ghost" onclick="fecharModal()">Cancelar</button>
            <button class="btn btn-green" onclick="salvarTransacao()">Salvar Nuvem</button>
        </div>
    </div>
</div>

<script type="module">
    // --- IMPORTANDO FIREBASE DIRETO DO CDN DO GOOGLE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ==========================================================
    // ‚ö†Ô∏è SUAS CONFIGURA√á√ïES (MANTIDAS) ‚ö†Ô∏è
    // ==========================================================
    const firebaseConfig = {
        apiKey: "AIzaSyDLlUTDD0iQawJdSDh6sZ_VR8aHNfK7VAc",
        authDomain: "financecontrol-5536d.firebaseapp.com",
        projectId: "financecontrol-5536d",
        storageBucket: "financecontrol-5536d.firebasestorage.app",
        messagingSenderId: "1088154985728",
        appId: "1:1088154985728:web:713aea749d0b9983fdffe5",
        measurementId: "G-3G6YZ5GQ9W"
    };

    // Inicializando Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const dbCollection = collection(db, "lancamentos"); // Nome da cole√ß√£o no Firestore

    // Estado Local (para renderiza√ß√£o)
    let transacoesLocais = [];
    let chartRosca = null;
    let chartBarras = null;
    let chartCartoes = null;

    // Categorias
    const categoriasReceita = ['Sal√°rio', 'Freelance', 'Investimentos', 'Outros'];
    const categoriasDespesa = ['Moradia', 'Alimenta√ß√£o', 'Transporte', 'Lazer', 'Sa√∫de', 'Educa√ß√£o', 'Eletr√¥nicos', 'Outros'];

    // === LISTENERS DO DOM (Conectando HTML ao M√≥dulo JS) ===
    window.onload = () => {
        document.getElementById('dataInput').valueAsDate = new Date();
        iniciarEscutaRealtime(); // Come√ßa a ouvir o banco de dados
    };

    // Escuta mudan√ßas nos filtros para redesenhar a tela
    document.getElementById('filtroMes').addEventListener('change', atualizarTela);
    document.getElementById('filtroAno').addEventListener('change', atualizarTela);

    // === FUN√á√ÉO CORE: LISTENER REALTIME (O Segredo do Firebase) ===
    function iniciarEscutaRealtime() {
        document.getElementById('loading').style.display = 'block';
        
        // onSnapshot: sempre que o banco mudar (eu ou outra pessoa), roda isso:
        onSnapshot(dbCollection, (snapshot) => {
            transacoesLocais = [];
            snapshot.forEach((doc) => {
                transacoesLocais.push({ id: doc.id, ...doc.data() });
            });
            
            document.getElementById('loading').style.display = 'none';
            atualizarTela();
        });
    }

    // === SALVAR (Agora usando Batch para parcelamento eficiente) ===
    window.salvarTransacao = async function() {
        const desc = document.getElementById('descInput').value;
        const valorTotal = parseFloat(document.getElementById('valorInput').value);
        let cat = document.getElementById('catSelect').value;
        const dataStr = document.getElementById('dataInput').value;
        const tipo = document.getElementById('tipoTransacao').value;
        const metodo = document.getElementById('metodoInput').value;

        if (!desc || isNaN(valorTotal) || !dataStr) { alert("Preencha tudo!"); return; }
        if (cat === 'Outros') cat = document.getElementById('catCustom').value || cat;

        document.getElementById('loading').style.display = 'block';
        const batch = writeBatch(db); // Cria um lote de grava√ß√£o

        if (metodo === 'credito') {
            const parcelas = parseInt(document.getElementById('parcelasSelect').value);
            const cartao = document.getElementById('cartaoSelect').value;
            const valorParcela = valorTotal / parcelas;

            for (let i = 0; i < parcelas; i++) {
                let dataParcela = new Date(dataStr + 'T12:00:00');
                dataParcela.setMonth(dataParcela.getMonth() + i);
                
                // Cria refer√™ncia de documento novo
                const newDocRef = doc(dbCollection); 
                batch.set(newDocRef, {
                    descricao: `${desc} (${i+1}/${parcelas})`,
                    valor: valorParcela,
                    categoria: cat,
                    data: dataParcela.toISOString().split('T')[0],
                    tipo: 'despesa',
                    metodo: 'credito',
                    cartao: cartao,
                    createdAt: new Date()
                });
            }
        } else {
            const newDocRef = doc(dbCollection);
            batch.set(newDocRef, {
                descricao: desc,
                valor: valorTotal,
                categoria: cat,
                data: dataStr,
                tipo: tipo,
                metodo: metodo,
                cartao: null,
                createdAt: new Date()
            });
        }

        await batch.commit(); // Envia tudo de uma vez
        fecharModal();
    }

    // === DELETAR ===
    window.deletarTransacao = async function(id) {
        if(confirm("Excluir registro da nuvem?")) {
            document.getElementById('loading').style.display = 'block';
            await deleteDoc(doc(db, "lancamentos", id));
        }
    }

    // === RESET GLOBAL ===
    window.limparDados = async function() {
        if(confirm("PERIGO: Isso apaga TODO o banco de dados. Confirmar?")) {
            document.getElementById('loading').style.display = 'block';
            const querySnapshot = await getDocs(dbCollection);
            const batch = writeBatch(db);
            querySnapshot.forEach((doc) => {
                batch.delete(doc.ref);
            });
            await batch.commit();
        }
    }

    // === ATUALIZA√á√ÉO DE TELA (Mesma l√≥gica visual da v7) ===
    function atualizarTela() {
        const anoFiltro = document.getElementById('filtroAno').value;
        const mesFiltro = document.getElementById('filtroMes').value;

        const filtradas = transacoesLocais.filter(t => {
            const dataT = new Date(t.data + 'T12:00:00');
            const mesmoAno = dataT.getFullYear() == anoFiltro;
            if (mesFiltro === 'todos') return mesmoAno;
            return mesmoAno && dataT.getMonth() == mesFiltro;
        });

        // C√°lculos
        const rec = filtradas.filter(t => t.tipo === 'receita').reduce((a,b)=>a+b.valor,0);
        const desp = filtradas.filter(t => t.tipo === 'despesa').reduce((a,b)=>a+b.valor,0);
        
        document.getElementById('totalReceitas').innerText = formatarMoeda(rec);
        document.getElementById('totalDespesas').innerText = formatarMoeda(desp);
        const saldo = rec - desp;
        const elSaldo = document.getElementById('totalSaldo');
        elSaldo.innerText = formatarMoeda(saldo);
        elSaldo.style.color = saldo >= 0 ? 'var(--green-neon)' : 'var(--red-neon)';

        renderizarTabela(filtradas);
        renderizarGraficos(filtradas);
    }

    // === RENDERIZADORES (Tabela e Gr√°ficos) ===
    function renderizarTabela(lista) {
        const tbody = document.getElementById('tabelaTransacoes');
        tbody.innerHTML = '';
        lista.sort((a,b) => new Date(b.data) - new Date(a.data));
        
        lista.forEach(t => {
            const tr = document.createElement('tr');
            let metodoHtml = t.metodo === 'credito' 
                ? `<span class="tag tag-credito">üí≥ ${t.cartao}</span>` 
                : `<span style="font-size:0.8rem">D√©bito/Pix</span>`;

            tr.innerHTML = `
                <td>${formatarData(t.data)}</td>
                <td>${t.descricao}</td>
                <td>${t.categoria}</td>
                <td>${metodoHtml}</td>
                <td style="color:${t.tipo==='receita'?'var(--green-neon)':'var(--red-neon)'}">${t.tipo==='receita'?'+':'-'} ${formatarMoeda(t.valor)}</td>
                <td><button class="btn-delete" onclick="deletarTransacao('${t.id}')">‚úï</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderizarGraficos(lista) {
        // L√≥gica de Gr√°ficos (Rosca, Pizza, Barras)
        const despesas = lista.filter(t => t.tipo === 'despesa');
        const cats = {}; despesas.forEach(t => cats[t.categoria] = (cats[t.categoria] || 0) + t.valor);
        
        if(chartRosca) chartRosca.destroy();
        chartRosca = new Chart(document.getElementById('graficoRosca'), {
            type: 'doughnut', data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: ['#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#8b5cf6'], borderWidth: 0 }] },
            options: { plugins: { legend: { position: 'right', labels: { color: '#94a3b8', boxWidth: 10 } } } }
        });

        // --- ATEN√á√ÉO: NUBANK REMOVIDO DAQUI TAMB√âM ---
        const cartoes = { 'Itau': 0, 'Mercado Pago': 0 };
        let totalFatura = 0;
        lista.filter(t => t.metodo === 'credito').forEach(t => { if(cartoes[t.cartao]!==undefined) { cartoes[t.cartao]+=t.valor; totalFatura+=t.valor; }});
        document.getElementById('totalCreditoTexto').innerText = formatarMoeda(totalFatura);

        if(chartCartoes) chartCartoes.destroy();
        chartCartoes = new Chart(document.getElementById('graficoCartoes'), {
            type: 'pie', 
            data: { 
                labels: ['Ita√∫', 'MP'], 
                datasets: [{ 
                    data: [cartoes['Itau'], cartoes['Mercado Pago']], 
                    backgroundColor: ['#f97316', '#009ee3'], // Removido roxo do Nubank
                    borderWidth: 0 
                }] 
            },
            options: { plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8' } } } }
        });

        if(chartBarras) chartBarras.destroy();
        const totR = lista.filter(t=>t.tipo==='receita').reduce((a,b)=>a+b.valor,0);
        const totD = lista.filter(t=>t.tipo==='despesa').reduce((a,b)=>a+b.valor,0);
        chartBarras = new Chart(document.getElementById('graficoBarras'), {
            type: 'bar', data: { labels: ['Receitas', 'Despesas'], datasets: [{ data: [totR, totD], backgroundColor: ['#10b981', '#ef4444'], borderRadius: 4 }] },
            options: { scales: { y: { beginAtZero: true, grid: { color: '#2d3748' }, ticks: { color: '#94a3b8' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } }, plugins: { legend: { display: false } } }
        });
    }

    // === HELPER FUNCTIONS GLOBAIS ===
    // Precisam ser anexadas a window pois estamos dentro de um M√≥dulo
    window.abrirModal = function(tipo) {
        document.getElementById('modalTransacao').style.display = 'flex';
        document.getElementById('tipoTransacao').value = tipo;
        document.getElementById('metodoInput').parentElement.style.display = tipo === 'receita' ? 'none' : 'block';
        
        // Reset
        document.getElementById('descInput').value = '';
        document.getElementById('valorInput').value = '';
        document.getElementById('parcelasSelect').value = '1';
        document.getElementById('divDetalhesCredito').classList.add('hidden');
        document.getElementById('metodoInput').value = 'debito';

        const sel = document.getElementById('catSelect'); sel.innerHTML = '';
        const list = tipo === 'receita' ? categoriasReceita : categoriasDespesa;
        list.forEach(c => { let opt = document.createElement('option'); opt.value = c; opt.innerText = c; sel.appendChild(opt); });
    }
    
    window.fecharModal = function() { document.getElementById('modalTransacao').style.display = 'none'; }
    window.verificarCategoriaCustom = function(v) { document.getElementById('catCustom').classList.toggle('hidden', v !== 'Outros'); }
    window.verificarMetodoPagamento = function(v) { document.getElementById('divDetalhesCredito').classList.toggle('hidden', v !== 'credito'); }

    function formatarMoeda(v) { return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    function formatarData(d) { const [a,m,dia] = d.split('-'); return `${dia}/${m}/${a}`; }
    window.onclick = function(e) { if(e.target == document.getElementById('modalTransacao')) fecharModal(); }

</script>
</body>
</html>